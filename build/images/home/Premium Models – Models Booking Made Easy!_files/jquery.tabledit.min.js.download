if("undefined"==typeof jQuery)throw new Error("Tabledit requires jQuery library.");!function(v){"use strict";v.fn.Tabledit=function(t){if(!this.is("table"))throw new Error("Tabledit only works when applied to a table.");var r=this,e={url:window.location.href,inputClass:"form-control input-xs",toolbarClass:"btn-toolbar",groupClass:"btn-group btn-group-xs",dangerClass:"/*danger*/",warningClass:"warning",mutedClass:"text-muted",eventType:"click",rowIdentifier:"id",hideIdentifier:!1,autoFocus:!0,editButton:!0,deleteButton:!0,saveButton:!0,restoreButton:!1,addButton:!0,buttons:{edit:{class:"btn btn-xs btn-default",html:'<span class="glyphicon glyphicon-pencil"></span>',action:"edit"},add:{class:"btn btn-xs btn-default",html:'<span class="fa fa-plus"></span> Agregar',action:"add"},delete:{class:"btn btn-xs btn-default",html:'<span class="glyphicon glyphicon-trash"></span>',action:"delete"},save:{class:"btn btn-xs btn-default",html:'<span class="fa fa-check"></span>'},cancel:{class:"btn btn-xs btn-default",html:'<span class="fa fa-times"></span>'},restore:{class:"btn btn-xs btn-warning",html:"Restaurar",action:"restore"},confirm:{class:"btn btn-xs btn-danger",html:"Confirmar"}},onDraw:function(){},onSuccess:function(){},onFail:function(){},onAlways:function(){},onAjax:function(){}},b=v.extend(!0,e,t),a="undefined",d="undefined",n={identifier:function(){b.hideIdentifier&&r.find("th:nth-child("+parseInt(b.columns.identifier[0])+"1), tbody td:nth-child("+parseInt(b.columns.identifier[0])+"1)").hide(),r.find("tbody td:nth-child("+(parseInt(b.columns.identifier[0])+1)+")").each(function(){var t='<span class="tabledit-span tabledit-identifier">'+v(this).text()+"</span>",e='<input class="tabledit-input tabledit-identifier" type="hidden" name="'+b.columns.identifier[1]+'" value="'+v(this).text()+'" disabled>';v(this).html(t+e),v(this).parent("tr").attr(b.rowIdentifier,v(this).text())})},editable:function(){for(var e=0;e<b.columns.editable.length;e++){r.find("tbody td:nth-child("+(parseInt(b.columns.editable[e][0])+1)+")").each(function(){var n=v(this).text();b.editButton||v(this).css("cursor","pointer");var t='<span class="tabledit-span">'+n+"</span>";if(void 0!==b.columns.editable[e][2]){var i='<select class="tabledit-input '+b.inputClass+'" name="'+b.columns.editable[e][1]+'" style="display: none;" disabled>';v.each(jQuery.parseJSON(b.columns.editable[e][2]),function(t,e){i+=n===e?'<option value="'+t+'" selected>'+e+"</option>":'<option value="'+t+'">'+e+"</option>"}),i+="</select>"}else i='<input class="tabledit-input '+b.inputClass+'" type="text" name="'+b.columns.editable[e][1]+'" value="'+v(this).text()+'" style="display: none;" disabled>';v(this).html(t+i),v(this).addClass("tabledit-view-mode")})}},toolbar:function(){if(b.editButton||b.deleteButton){var t="",e="",n="",i="",a="",d="",s="";0===r.find("th.tabledit-toolbar-column").length&&r.find("tr:first").append('<th class="tabledit-toolbar-column"></th>'),b.addButton&&(d='<button type="button" class="tabledit-add-button '+b.buttons.add.class+'" style="float: none;">'+b.buttons.add.html+"</button>",s='<button type="button" class="tabledit-cancel-button '+b.buttons.cancel.class+'" style="float: none;display: none;">'+b.buttons.cancel.html+"</button>"),b.editButton&&(t='<button type="button" class="tabledit-edit-button '+b.buttons.edit.class+'" style="float: none;">'+b.buttons.edit.html+"</button>"),b.deleteButton&&(e='<button type="button" class="tabledit-delete-button '+b.buttons.delete.class+'" style="float: none;">'+b.buttons.delete.html+"</button>",a='<button type="button" class="tabledit-confirm-button '+b.buttons.confirm.class+'" style="display: none; float: none;">'+b.buttons.confirm.html+"</button>"),b.editButton&&b.saveButton&&(n='<button type="button" class="tabledit-save-button '+b.buttons.save.class+'" style="display: none; float: none;">'+b.buttons.save.html+"</button>"),b.deleteButton&&b.restoreButton&&(i='<button type="button" class="tabledit-restore-button '+b.buttons.restore.class+'" style="display: none; float: none;">'+b.buttons.restore.html+"</button>");var l='<div class="tabledit-toolbar '+b.toolbarClass+'" style="text-align: left;">\n                                           <div class="'+b.groupClass+'" style="float: none;">'+t+e+"</div>\n                                           "+n+"\n                                           "+s+"\n                                           "+a+"\n                                           "+i+"\n                                       </div></div>",o='<div class="tabledit-toolbar '+b.toolbarClass+'" style="text-align: left;">\n                                           <div class="'+b.groupClass+' pull-right" style="float: none;">'+d+"</div></div></div>";r.find("th.tabledit-toolbar-column").html(o),r.find("tr:gt(0)").append('<td style="white-space: nowrap; width: 1%;">'+l+"</td>")}}},i=function(t){var e=v(t).parent("tr");v(t).parent("tr").find(".tabledit-input.tabledit-identifier").prop("disabled",!0),v(t).find(".tabledit-input").blur().hide().prop("disabled",!0),v(t).find(".tabledit-span").show(),v(t).addClass("tabledit-view-mode").removeClass("tabledit-edit-mode"),b.editButton&&(e.find("button.tabledit-save-button").hide(),e.find("button.tabledit-edit-button").removeClass("active").blur()),b.addButton&&(e.find("button.tabledit-edit-button").show(),e.find("button.tabledit-delete-button").show(),e.find("button.tabledit-save-button").hide(),e.find("button.tabledit-cancel-button").hide())},s=function(t){p.reset(t);var e=v(t).parent("tr");e.find(".tabledit-input.tabledit-identifier").prop("disabled",!1),v(t).find(".tabledit-span").hide();var n=v(t).find(".tabledit-input");n.prop("disabled",!1).show(),b.autoFocus&&n.focus(),v(t).addClass("tabledit-edit-mode").removeClass("tabledit-view-mode"),b.editButton&&(e.find("button.tabledit-edit-button").addClass("active"),e.find("button.tabledit-save-button").show())},l=function(t){p.reset(t);var e=v(t).parent("tr");e.find(".tabledit-input.tabledit-identifier").prop("disabled",!1),v(t).find(".tabledit-span").hide();var n=v(t).find(".tabledit-input");n.prop("disabled",!1).show(),b.autoFocus&&n.focus(),v(t).addClass("tabledit-edit-mode").removeClass("tabledit-view-mode"),b.addButton&&(e.find("button.tabledit-edit-button").hide(),e.find("button.tabledit-delete-button").hide(),e.find("button.tabledit-save-button").show(),e.find("button.tabledit-cancel-button").show())},o=function(t){v(t).each(function(){var t=v(this).find(".tabledit-input"),e=v(this).find(".tabledit-span").text();t.is("select")?t.find("option").filter(function(){return v.trim(v(this).text())===e}).attr("selected",!0):t.val(e),i(this)})},u=function(t){v(t).parent("tr").remove()},c=function(t){!1!==h(b.buttons.edit.action)&&(v(t).each(function(){var t=v(this).find(".tabledit-input");t.is("select")?v(this).find(".tabledit-span").text(t.find("option:selected").text()):v(this).find(".tabledit-span").text(t.val()),i(this)}),a=v(t).parent("tr"))},f=function(t){!1!==h(b.buttons.add.action)?(v(t).each(function(){var t=v(this).find(".tabledit-input");t.is("select")?v(this).find(".tabledit-span").text(t.find("option:selected").text()):v(this).find(".tabledit-span").text(t.val()),i(this)}),a=v(t).parent("tr")):v(t).parent("tr").remove()},p={reset:function(t){r.find(".tabledit-confirm-button").hide(),r.find(".tabledit-delete-button").removeClass("active").blur()},submit:function(t){p.reset(t),v(t).parent("tr").find("input.tabledit-identifier").attr("disabled",!1);var e=h(b.buttons.delete.action);if(v(t).parents("tr").find("input.tabledit-identifier").attr("disabled",!0),!1!==e){v(t).parent("tr").addClass("tabledit-deleted-row"),v(t).parent("tr").addClass(b.mutedClass).find(".tabledit-toolbar button:not(.tabledit-restore-button)").attr("disabled",!0),v(t).find(".tabledit-restore-button").show(),d=v(t).parent("tr");var n=v(t).closest("tbody");1==v(t).closest("tbody").find("tr").length?(v(".tabledit-span",v(t).parent("tr")).text(""),v(".tabledit-input",v(t).parent("tr")).val("")):v(t).parent("tr").remove(),n.find("tr").each(function(t,e){var n=t+1;v(this).find("td:first-child").html(n)})}},confirm:function(t){r.find("td.tabledit-edit-mode").each(function(){o(this)}),v(t).find(".tabledit-delete-button").addClass("active"),v(t).find(".tabledit-confirm-button").show()},restore:function(t){v(t).parent("tr").find("input.tabledit-identifier").attr("disabled",!1);var e=h(b.buttons.restore.action);v(t).parents("tr").find("input.tabledit-identifier").attr("disabled",!0),!1!==e&&(v(t).parent("tr").removeClass("tabledit-deleted-row"),v(t).parent("tr").removeClass(b.mutedClass).find(".tabledit-toolbar button").attr("disabled",!1),v(t).find(".tabledit-restore-button").hide(),v(t).parent("tr"))}};function h(i){var t=r.find(".tabledit-input").serialize()+"&action="+i;if(!1===b.onAjax(i,t))return!1;var e=v.post(b.url,t,function(t,e,n){i===b.buttons.edit.action&&(a.removeClass(b.dangerClass).addClass(b.warningClass),setTimeout(function(){r.find("tr."+b.warningClass).removeClass(b.warningClass)},1400)),b.onSuccess(t,e,n)},"json");return e.fail(function(t,e,n){i===b.buttons.delete.action?(d.removeClass(b.mutedClass).addClass(b.dangerClass),d.find(".tabledit-toolbar button").attr("disabled",!1),d.find(".tabledit-toolbar .tabledit-restore-button").hide()):i===b.buttons.edit.action&&a.addClass(b.dangerClass),b.onFail(t,e,n)}),e.always(function(){b.onAlways()}),e}return n.identifier(),n.editable(),n.toolbar(),b.onDraw(),b.deleteButton&&(r.on("click","button.tabledit-delete-button",function(t){if(!0!==t.handled){t.preventDefault();var e=v(this).hasClass("active"),n=v(this).parents("td");p.reset(n),e||p.confirm(n),t.handled=!0}}),r.on("click","button.tabledit-confirm-button",function(t){if(!0!==t.handled){t.preventDefault();var e=v(this).parents("td");p.submit(e),t.handled=!0}})),b.restoreButton&&r.on("click","button.tabledit-restore-button",function(t){!0!==t.handled&&(t.preventDefault(),p.restore(v(this).parents("td")),t.handled=!0)}),b.addButton&&(r.on("click","button.tabledit-add-button",function(t){if(!0!==t.handled){if(t.preventDefault(),!v(this).hasClass("active")){var e="#"+r.attr("id"),n=parseInt(v(e+" tr:last").attr("id"))+1,i=v(e+" tr:last").clone();v(".tabledit-span",i).text(""),v(".tabledit-input",i).val(""),v(e+" tbody").append(i),v(e+" tbody tr:last").attr("id",n),v(e+" tbody tr").each(function(t,e){var n=t+1;v(this).find("td:first-child").html(n)}),v(v(e+" tbody tr:last").find("td.tabledit-view-mode").get().reverse()).each(function(){l(this)})}t.handled=!0}}),r.on("click","button.tabledit-save-button",function(t){!0!==t.handled&&(t.preventDefault(),f(v(this).parents("tr").find("td.tabledit-edit-mode")),t.handled=!0)}),r.on("click","button.tabledit-cancel-button",function(t){!0!==t.handled&&(t.preventDefault(),u(v(this).parents("tr").find("td.tabledit-edit-mode")),t.handled=!0)})),b.editButton?(r.on("click","button.tabledit-edit-button",function(t){if(!0!==t.handled){t.preventDefault();var e=v(this),n=e.hasClass("active");o(r.find("td.tabledit-edit-mode")),n||v(e.parents("tr").find("td.tabledit-view-mode").get().reverse()).each(function(){s(this)}),t.handled=!0}}),r.on("click","button.tabledit-save-button",function(t){!0!==t.handled&&(t.preventDefault(),c(v(this).parents("tr").find("td.tabledit-edit-mode")),t.handled=!0)})):(r.on(b.eventType,"tr:not(.tabledit-deleted-row) td.tabledit-view-mode",function(t){!0!==t.handled&&(t.preventDefault(),o(r.find("td.tabledit-edit-mode")),s(this),t.handled=!0)}),r.on("change","select.tabledit-input:visible",function(){!0!==event.handled&&(c(v(this).parent("td")),event.handled=!0)}),v(document).on("click",function(t){var e=r.find(".tabledit-edit-mode");e.is(t.target)||0!==e.has(t.target).length||o(r.find(".tabledit-input:visible").parent("td"))})),v(document).on("keyup",function(t){var e=r.find(".tabledit-input:visible"),n=r.find(".tabledit-confirm-button");if(0<e.length)var i=e.parents("td");else{if(!(0<n.length))return;i=n.parents("td")}switch(t.keyCode){case 9:b.editButton||(c(i),s(i.closest("td").next()));break;case 13:c(i);break;case 27:o(i),p.reset(i)}}),this}}(jQuery);